---
title: "UFC Modeling"
author: "Andrew Couch"
date: "1/31/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidymodels)
library(vip)
library(poissonreg)
library(keras)
library(here)

df <- read_csv(here("Data/fight_data.csv"))
match_df <- read_csv(here("Data/fights.csv"))
fighter_df <- read_csv(here("Data/fighter_table.csv"))
```


# Individual Component Data 
```{r}
target_components <- df %>% 
  select(fight_pk, fighter, kd, 
         sig_strike_attempts, sig_strike_landed,
         strike_attempts, strike_landed,
         sub_attempts, td_attempts, 
         td_landed) %>% 
  rename_at(vars(!matches("fight_pk|fighter")), ~paste0("target_", .x))


ind_comp_df <- match_df %>% 
  arrange(desc(fight_pk)) %>% 
  select_at(vars(!matches("rev|opp_fighter|res|loss|win"))) %>% 
  left_join(target_components, by = c("fight_pk", "fighter")) %>% 
  select_at(vars(contains("target"), everything())) %>% 
  select(fight_pk, fighter, everything()) %>% 
  mutate(is_favored = as.factor(is_favored),
         strike_favor = as.factor(strike_favor),
         sub_favor = as.factor(sub_favor)) %>% 
  mutate_if(is.numeric, ~replace_na(.x, 0))
```

# Outcome Model
```{r}
dif_df <- target_components %>% 
  pivot_longer(-c(fight_pk, fighter), values_to = "fighter_val") %>% 
  left_join(target_components %>% 
              rename(opponent = fighter) %>% 
              pivot_longer(-c(fight_pk, opponent), values_to = "opponent_val"),
            by = c("fight_pk", "name")) %>% 
  filter(fighter != opponent) %>% 
  mutate(dif = fighter_val - opponent_val) %>% 
  select(fight_pk, fighter, name, dif) %>% 
  pivot_wider(names_from = name, values_from = dif) %>% 
  left_join(match_df %>% select(fight_pk, fighter, res), by = c("fight_pk", "fighter")) %>% 
  select(fight_pk, fighter, res, everything())
```

```{r}
draw_matches <- match_df %>% 
  group_by(fight_pk) %>% 
  summarise(res = sum(res)) %>% 
  ungroup() %>% 
  filter(res == 0) %>% 
  select(fight_pk)
```

## Data Partition
```{r}
model_dif_df <- dif_df %>% 
  group_by(fight_pk) %>% 
  sample_n(1) %>% 
  ungroup() %>% 
  anti_join(draw_matches, by = "fight_pk") %>% 
  mutate(res = if_else(res == 1, "Win", "Lose"),
         res = as.factor(res),
         res = fct_relevel(res, "Win", "Lose")) %>% 
  select(fight_pk, fighter, res, target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed)
```

```{r}
set.seed(31)

dif_split <- initial_split(model_dif_df)
train_dif <- training(dif_split)
test_dif <- testing(dif_split)
k_folds_dif <- vfold_cv(train_dif)
```

## Pre-Processing and Metrics
```{r}
dif_rec <- recipe(res~., data = train_dif) %>% 
  step_rm(fight_pk, fighter) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes())

dif_metrics <- metric_set(accuracy, roc_auc, sens, spec, mn_log_loss)

dif_control <- control_grid(save_pred = TRUE)
```

## Modeling
```{r}
dif_xgboost <- boost_tree(trees = tune(), tree_depth = tune()) %>% 
  set_mode("classification") %>% 
  set_engine("xgboost")

dif_xgboost_grid <- grid_max_entropy(parameters(dif_xgboost), size = 10)
```

```{r,eval=FALSE}
dif_tune <- tune_grid(
  dif_xgboost,
  dif_rec,
  metrics = dif_metrics,
  control = dif_control,
  grid = dif_xgboost_grid,
  resamples = k_folds_dif
)

save(dif_tune, file = here("Data/outcome_tune.RDS"))
```

# Components Model
## Data Partition
```{r}
set.seed(31)

ind_split <- initial_split(ind_comp_df)
train_ind <- training(ind_split)
test_ind <- testing(ind_split)
k_folds_ind <- vfold_cv(train_ind)
```

## Pre-Processing and Metrics
```{r}
ind_metrics <- metric_set(rmse, mae, rsq, mape, smape)

kd_rec <- recipe(target_kd ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_sig_strike_attempts, target_strike_attempts, target_strike_landed,
          target_sub_attempts, target_td_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

sig_strike_attempts_rec <- recipe(target_sig_strike_attempts ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_kd, target_strike_attempts, target_strike_landed,
          target_sub_attempts, target_td_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

strike_attempts_rec <- recipe(target_strike_attempts ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_kd, target_sig_strike_attempts, target_strike_landed,
          target_sub_attempts, target_td_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

strike_landed_rec <- recipe(target_strike_landed ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_kd, target_sig_strike_attempts, target_strike_attempts,
          target_sub_attempts, target_td_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

sub_attempts_rec <- recipe(target_sub_attempts ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_kd, target_sig_strike_attempts, target_strike_attempts, target_strike_landed,
          target_td_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

td_attempts_rec <- recipe(target_td_attempts ~ ., data = train_ind) %>% 
  step_rm(fight_pk, fighter,
          target_kd, target_sig_strike_attempts, target_strike_attempts, target_strike_landed,
          target_sub_attempts, target_td_landed) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)

td_landed_rec <- recipe(target_td_landed ~ ., data = train_ind) %>% 
 step_rm(fight_pk, fighter,
          target_kd, target_sig_strike_attempts, target_strike_attempts, target_strike_landed,
          target_sub_attempts, target_td_attempts) %>% 
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
  step_normalize(all_numeric(), -all_outcomes()) %>% 
  step_dummy(all_nominal(), -all_outcomes(), one_hot = TRUE)
```

## Modeling
### XGBoost
```{r}
ind_xgboost <- boost_tree(trees = tune(), tree_depth = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("xgboost")

ind_xgboost_grid <- grid_max_entropy(parameters(ind_xgboost), size = 10)
```

```{r,eval=FALSE}
kd_tune <- tune_grid(
  ind_xgboost,
  kd_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

sig_strike_attempts_tune <- tune_grid(
  ind_xgboost,
  sig_strike_attempts_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

strike_attempts_tune <- tune_grid(
  ind_xgboost,
  strike_attempts_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

strike_landed_tune <- tune_grid(
  ind_xgboost,
  strike_landed_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

sub_attempts_tune <- tune_grid(
  ind_xgboost,
  sub_attempts_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

td_attempts_tune <- tune_grid(
  ind_xgboost,
  td_attempts_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

td_landed_tune <- tune_grid(
  ind_xgboost,
  td_landed_rec,
  metrics = ind_metrics,
  grid = ind_xgboost_grid,
  resamples = k_folds_ind
)

save(dif_tune, kd_tune, sig_strike_attempts_tune, strike_attempts_tune,
     strike_landed_tune, sub_attempts_tune, td_attempts_tune, td_landed_tune,
     file = here("Data/tune_results.RDS"))
```


### Poisson
```{r}
poisson_model <- poisson_reg(penalty = tune(), mixture = tune()) %>% 
  set_engine("glmnet")

poisson_grid <- grid_regular(parameters(poisson_model), levels = 5)
```


```{r,eval=FALSE}
poisson_kd_tune <- tune_grid(
  poisson_model,
  kd_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_sig_strike_attempts_tune <- tune_grid(
  poisson_model,
  sig_strike_attempts_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_strike_attempts_tune <- tune_grid(
  poisson_model,
  strike_attempts_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_strike_landed_tune <- tune_grid(
  poisson_model,
  strike_landed_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_sub_attempts_tune <- tune_grid(
  poisson_model,
  sub_attempts_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_td_attempts_tune <- tune_grid(
  poisson_model,
  td_attempts_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

poisson_td_landed_tune <- tune_grid(
  poisson_model,
  td_landed_rec,
  metrics = ind_metrics,
  grid = poisson_grid,
  resamples = k_folds_ind
)

save(poisson_kd_tune, poisson_sig_strike_attempts_tune, poisson_strike_attempts_tune, poisson_strike_landed_tune,
     poisson_sub_attempts_tune, poisson_td_attempts_tune, poisson_td_landed_tune, file = here("Data/poisson_results.RDS"))
```




### Neural Network
```{r}
train_output <- train_ind %>% select(target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed)
train_input <- train_ind %>% select_at(vars(!matches("target_|fight_pk|fighter")))

test_output <- test_ind %>% select(target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed)
test_input <- test_ind %>% select_at(vars(!matches("target_|fight_pk|fighter")))

neural_network_rec <- recipe(~., data = train_input) %>% 
  step_YeoJohnson(all_numeric()) %>% 
  step_range(all_numeric()) %>% 
  step_dummy(all_nominal(), one_hot = TRUE) %>% 
  prep()

train_input <- bake(neural_network_rec, new_data = train_input) %>% as.matrix()
test_input <- bake(neural_network_rec, new_data = test_input) %>% as.matrix()

train_output <- as.matrix(train_output)
test_output <- as.matrix(test_output)
```

input_model <- layer_input(shape = ncol(train_input), dtype = "int32", name = "fights") %>% 
  layer_dense(units = 128, activation = "relu") %>% 
  layer_dense(units = 128, activation = "relu") %>% 
  layer_dense(units = 128, activation = "relu") 

sig_strike_attempts_pred <- input_model %>% layer_dense(units = 1, name = "sig_strike_attempts")
sig_strike_landed_pred <- input_model %>% layer_dense(units = 1, name = "sig_strike_landed")
strike_attempts_pred <- input_model %>% layer_dense(units = 1, name = "strike_attempts")
strike_landed_pred <- input_model %>% layer_dense(units = 1, name = "strike_landed")
sub_attempts_pred <- input_model %>% layer_dense(units = 1, name = "sub_attempts")
td_attempts_pred <- input_model %>% layer_dense(units = 1, name = "td_attempts")
td_landed_pred <- input_model %>% layer_dense(units = 1, name = "td_landed")



```{r}
model <- keras_model_sequential() %>% 
  layer_dense(input_shape = ncol(train_input), units = 512, activation = "relu") %>% 
  layer_dense(units = 512, activation = "relu") %>% 
  layer_dropout(rate = 0.05) %>% 
  layer_dense(units = 512, activation = "relu") %>% 
  layer_dense(units = ncol(train_output))

model %>% 
  compile(
    optimizer = optimizer_adam(),
    loss = "mse",
    metrics = list("mean_absolute_error"),
    loss_weights = c(0.13154802, 0.42965849, 0.19235573, 0.14902811, 0.09740966)
  )

history <- model %>% fit(
  x = train_input,
  y = train_output,
  epochs = 200,
  validation_split = 0.2,
  callbacks = callback_early_stopping(patience = 20)
)

colMeans(abs(predict(model, test_input) - test_output)) 
```


```{r}
train_output2 <- train_ind %>% 
  select(fight_pk, fighter, target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed) %>% 
  left_join(df %>% select(fight_pk, fighter, res), by = c("fight_pk", "fighter")) %>% 
  select(-fight_pk, -fighter) %>% 
  mutate(res = if_else(res == "W", 1, 0)) %>% 
  rename(target_res = res) %>% 
  as.matrix()

test_output2 <- test_ind %>% 
  select(fight_pk, fighter, target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed) %>% 
  left_join(df %>% select(fight_pk, fighter, res), by = c("fight_pk", "fighter")) %>% 
  select(-fight_pk, -fighter) %>% 
  mutate(res = if_else(res == "W", 1, 0)) %>% 
  rename(target_res = res) %>%
  as.matrix()
```


```{r}
fight_input <- layer_input(shape = ncol(train_input), dtype = "int32", name = "fights")

base_model <- fight_input %>% 
  layer_dense(units = 512, activation = "relu") %>% 
  layer_dense(units = 512, activation = "relu") %>% 
  layer_dense(units = 512, activation = "relu") 

target_kd <- base_model %>% layer_dense(units = 1, name = "kd")
target_sig_strike_landed <- base_model %>% layer_dense(units = 1, name = "sig_strike") 
target_strike_landed <- base_model %>% layer_dense(units = 1, name = "strike")
target_sub_attempts <- base_model %>% layer_dense(units = 1, name = "sub")
target_td_landed <- base_model %>% layer_dense(units = 1, name = "td")
target_res <- base_model %>% layer_dense(units = 1, name = "res", activation = "sigmoid")

model2 <- keras_model(
  fight_input,
  list(target_kd, target_sig_strike_landed, target_strike_landed, target_sub_attempts, target_td_landed, target_res)
)
```



```{r}
model2 %>% compile(
  optimizer = optimizer_rmsprop(),
  loss = list(kd = "mse", 
              sig_strike = "mse", 
              strike = "mse", 
              sub = "mse", 
              td = "mse", 
              res = "binary_crossentropy"),
  loss_weights = list(kd = 0.10523842, 
                      sig_strike = 0.34372679, 
                      strike = 0.15388458, 
                      sub = 0.11922249, 
                      td = 0.07792773, 
                      res = .2)
)

model2 %>% 
  fit(train_input, list(
    kd = train_output2[, 1],
    sig_strike = train_output2[, 2],
    strike = train_output2[, 3],
    sub = train_output2[, 4],
    td = train_output2[, 5],
    res = train_output2[, 6]
  ),
  epochs = 500,
  validation_split = 0.2,
  callbacks = callback_early_stopping(patience = 20),
  batch_size = 128)
```

```{r}
train_output2[1, ]
```

